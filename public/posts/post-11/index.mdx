---
title: '[트러블슈팅] 검색 시 불필요한 API 호출 방지하기'
description: '프로젝트에서 검색 기능을 구현하며 발생한 문제를 해결한 과정을 다룹니다.'
date: '2025년 05월 18일'
thumbnail: '/images/thumbnail/11.png'
tags: ['트러블슈팅', 'React']
---

import Image from 'next/image';

# 검색 시 불필요한 API 호출 방지하기

## 문제 상황

프로젝트에서 전략 탐색 기능(검색)을 구현하던 중 다음과 같은 문제가 발생했다.

- 문제 증상: 검색어를 입력할 때마다 목록 조회 API가 호출됨
- 기대 동작: 사용자가 Enter 키를 누르거나 검색 버튼을 클릭했을 때만 API 호출되어야 함

## 문제 원인 분석

코드를 살펴보니 두 가지 주요 원인이 있었다.

<br />

1. **useEffect의 의존성 배열 문제**

   아래 코드에서 `searchValue`가 의존성 배열에 포함되어 있어 검색어가 변경될 때마다 `fetchStrategies` 함수가 호출된다. 심지어 사용자가 단순히 공백을 입력해도 API가 호출될 수 있다.

   ```js
   useEffect(() => {
     if (Object.keys(activeFilters).length > 0 || searchValue.trim()) {
       fetchStrategies();
     }
   }, [searchValue, fetchStrategies]);
   ```

2. **검색 상태 관리 로직의 문제**

   아래 함수에서 `isSearching` 상태를 API 호출 후에 변경하기 때문에, 동일한 렌더링 사이클 내에서 다른 API가 호출될 수 있다. 예를 들어, searchStrategies API가 호출된 직후 `isSearching`이 false로 변경되면서 getStrategies API도 호출될 수 있다.

   ```js
   const fetchStrategies = useCallback(async () => {
     try {
       let response;
       const request = {
         page: currentPage,
         filters: activeFilters,
       };

       // 검색어가 있는 경우
       if (isSearching) {
         response = await mockApiService.searchStrategies({
           ...request,
           keyword: searchValue.trim(),
         });

         setIsSearching(false); // 검색 완료 후 상태 초기화
       }
       // 필터링
       else if (Object.keys(activeFilters).length > 0) {
         // 필터링 API 호출...
       }
       // 기본 전략 목록
       else {
         response = await mockApiService.getStrategies(request);
       }

       // 결과 처리...
     } catch (error) {
       console.error('API 요청 중 에러 발생:', error);
     }
   }, [currentPage, searchValue, activeFilters, currentTab]);
   ```

## 해결 방법

1.  **useEffect 의존성 수정**

    검색어 입력 시 자동 API 호출을 방지하기 위해 `searchValue`를 의존성 배열에서 제거한다.

    ```js
    useEffect(() => {
      if (Object.keys(activeFilters).length > 0) {
        fetchStrategies();
      }
    }, [fetchStrategies]); // searchValue 제거
    ```

2.  **검색 로직 개선**

    `fetchStrategies` 함수를 수정하여 검색 상태와 API 호출 로직을 명확히 분리한다.

    ```js
    const fetchStrategies = useCallback(async () => {
      try {
        let response;
        const request = {
          page: currentPage,
          keyword: searchValue,
          filters: activeFilters,
        };

        if (isSearching) {
          response = await mockApiService.searchStrategies({
            ...request,
            keyword: searchValue.trim(),
          });
        } else if (Object.keys(activeFilters).length > 0) {
          if (currentTab === 0) {
            response = await mockApiService.getFilteredStrategies(request);
          } else {
            response = await mockApiService.getAlgorithmStrategies(request);
          }
        } else {
          response = await mockApiService.getStrategies(request);
        }

        if (response?.code === 200) {
          setTableData(response.data.content);
          setTotalPages(response.data.totalPages);
        }

        // API 호출 완료 후 상태 초기화
        setIsSearching(false);
      } catch (error) {
        console.error('API 요청 중 에러 발생:', error);
        setIsSearching(false); // 에러 발생 시에도 상태 초기화
      }
    }, [currentPage, searchValue, activeFilters, currentTab, isSearching]);
    ```

3.  **검색 이벤트 핸들러 구현**

    Enter 키나 검색 버튼 클릭 시에만 검색을 실행하도록 이벤트 핸들러를 추가한다.

    ```js
    const handleSearch = () => {

    if (searchValue.trim()) {
        setIsSearching(true);
        fetchStrategies();
        }
    };

    const handleKeyPress = (e) => {
        if (e.key === 'Enter') {
        handleSearch();
        }
    };

    // JSX에서 사용

    <input
        type='text'
        value={searchValue}
        onChange={(e) => setSearchValue(e.target.value)}
        onKeyPress={handleKeyPress}
    />
    <button onClick={handleSearch}>검색</button>
    ```

## 최종 결과

- 검색어 입력 중에는 API가 호출되지 않음
- Enter 키를 누르거나 검색 버튼을 클릭할 때만 API 호출
- 중복 API 호출 방지

<br />

콘솔을 통해 Enter 키를 누르거나 검색 버튼을 클릭할 때만 API가 호출됨을 확인했다.

<Image
  src='/images/posts/11-1.png'
  alt='콘솔 이미지'
  width={455}
  height={242}
/>
